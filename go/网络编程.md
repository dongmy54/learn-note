## ç½‘ç»œç¼–ç¨‹
goè¿™é—¨è¯­è¨€ç”±äºå®ƒæœ‰gorountineå’Œchanneléå¸¸é€‚åˆwebç¼–ç¨‹ï¼Œèƒ½å¤Ÿå®ç°å¾ˆé«˜çš„å¹¶å‘ã€‚

ç½‘ç»œç¼–ç¨‹æœ¬è´¨ä¸Šæ˜¯åˆ©ç”¨çš„socket,åº•å±‚å€ŸåŠ©çš„æ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„ä¸€ç³»åˆ—èƒ½åŠ›ï¼›å½“ç„¶goè‡ªèº«ä¹Ÿåšäº†å¾ˆå¤šä¼˜åŒ–ï¼›

goæä¾›çš„ç½‘ç»œç¼–ç¨‹æ€»ä½“è€Œè¨€ï¼Œå’Œå…¶å®ƒè¯­è¨€å·®åˆ«ä¸å¤§ï¼Œä¹Ÿæ¯”è¾ƒå¥½æ‡‚ï¼›goå±è”½äº†åº•å±‚çš„å¤æ‚æ€§,å°†å¤æ‚ç•™ç»™è‡ªå·±ï¼Œå°†ç®€å•ç•™ç»™ä½¿ç”¨è€…,çœŸçš„å¾ˆä¸é”™ğŸ‘ï¼

ä¸‹é¢æˆ‘ä»¬ä¸€æ­¥æ­¥çœ‹çœ‹goä¸­ç½‘ç»œç¼–ç¨‹çš„å®ç°ï¼Œæœ¬ç¯‡æ¶‰åŠçš„ä»£ç ç›¸å¯¹æ¯”è¾ƒå¤šï¼Œè¯·è€å¿ƒçœ‹å“¦ï¼

### 1. TCPå®ç°

#### 1.1 ç®€å•TCPæœåŠ¡ç«¯-å®¢æˆ·ç«¯
- æœåŠ¡ç«¯
```go
package main

import (
	"fmt"
	"net"
)

func main() {
	// 1. ç›´æ¥listen
	listen, err := net.Listen("tcp", ":8080")
	if err != nil {
		fmt.Println("listen error: ", err)
		return
	}

	defer listen.Close()
	
  // æ‰“å°å‡ºç›‘å¬çš„ç«¯å£ä¿¡æ¯
	fmt.Println("listening on ", listen.Addr().String())

	for {
		// 2. Acceptæ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚
		conn, err := listen.Accept()
		if err != nil {
			fmt.Println("accept error: ", err)
			continue // è·³è¿‡æœ¬æ¬¡ ç»§ç»­ä¸‹ä¸€æ¬¡
		}

		// 3. å¼€ä¸€ä¸ªåç¨‹ å•ç‹¬å¤„ç†è¿æ¥
		go handelConn(conn)
	}
}

// å¤„ç†æ¥æ”¶åˆ°çš„è¿æ¥
// net.Connæ˜¯ä¸€ä¸ªæ¥å£,æ‹¥æœ‰Readå’ŒWriteæ–¹æ³•
func handelConn(conn net.Conn) {
	// å‡†å¤‡ä»connä¸­è¯»å–æ•°æ® å­˜å‚¨çš„åˆ‡ç‰‡
	data := make([]byte, 512)
	// è¿”å›è¯»å–çš„å­—èŠ‚æ•°ï¼Œé”™è¯¯
	n, err := conn.Read(data)
	if err != nil {
		fmt.Println("Read error: ", err)
		return
	}
	fmt.Printf("è¯»å–åˆ°å®¢æˆ·ç«¯ip: %s, é•¿åº¦ä¸ºï¼š%vçš„ä¿¡æ¯: %s\n", conn.RemoteAddr(), n, string(data))

	// å›å†™å®¢æˆ·ç«¯æ¶ˆæ¯
	_, err = conn.Write([]byte("æˆ‘å·²ç»æ”¶åˆ°ä½ çš„è¯·æ±‚ï¼"))
	if err != nil {
		fmt.Println("write error: ", err)
		return
	}
}

// listening on  [::]:8080
// è¯»å–åˆ°å®¢æˆ·ç«¯ip: [::1]:51644, é•¿åº¦ä¸ºï¼š11çš„ä¿¡æ¯: hello world
```


- å®¢æˆ·ç«¯
```go
package main

import (
	"fmt"
	"net"
)

func main() {
	// 1. å®¢æˆ·ç«¯æ‹¨å· tcp ip:port
	conn, err := net.Dial("tcp", "localhost:8080")
	if err != nil {
		fmt.Println("Dial error: ", err)
		return
	}

	defer conn.Close()

	// 2. å‘é€æ•°æ®
	_, err = conn.Write([]byte("hello world"))
	if err != nil {
		fmt.Println("Write error: ", err)
		return
	}

	// 3.è¯»å–æ•°æ®
	data := make([]byte, 512)
	n, err := conn.Read(data)
	if err != nil {
		fmt.Println("Read error: ", err)
		return
	}

	fmt.Printf("Read data length: %d, content: %s", n, data)
}


// Read data length: 30, content: æˆ‘å·²ç»æ”¶åˆ°ä½ çš„è¯·æ±‚ï¼%
```

#### 1.2ç²˜åŒ…é—®é¢˜
ä¸Šè¯‰çš„ä»£ç è™½ç„¶èƒ½æ­£å¸¸å·¥ä½œï¼Œä½†æ˜¯å¦‚æœå®¢æˆ·ç«¯ä¸€æ¬¡æ€§å‘é€å¾ˆå¤šä¿¡æ¯çš„æ—¶å€™,ä¼šæœ‰ç²˜åŒ…é—®é¢˜ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹ï¼Œæ€ä¹ˆæ¨¡æ‹Ÿå‘¢ï¼Ÿ
1. æŠŠå®¢æˆ·ç«¯æ”¹æˆå¾ªç¯å‘é€å¾ˆå¤šæ¬¡ï¼ˆæ¯”å¦‚60æ¬¡ï¼‰
2. æœåŠ¡ç«¯è¯»å–å®¢æˆ·ç«¯ä¿¡æ¯æ”¹æˆå¾ªç¯è¯»å–

- å®¢æˆ·ç«¯
```go
package main

import (
	"fmt"
	"net"
	"strings"
)

func main() {
	// 1. å®¢æˆ·ç«¯æ‹¨å· tcp ip:port
	conn, err := net.Dial("tcp", "localhost:8080")
	if err != nil {
		fmt.Println("Dial error: ", err)
		return
	}

	defer conn.Close()

	// æ„å»ºä¸€ä¸ªå¾ˆé•¿çš„å­—ç¬¦ä¸² ç”±60ä¸ª hellow worldç»„æˆ
	str := strings.Repeat("hello world", 60)

	// 2. å‘é€æ•°æ®
	_, err = conn.Write([]byte(str))
	if err != nil {
		fmt.Println("Write error: ", err)
		return
	}
}
```

- æœåŠ¡ç«¯
```go
package main

import (
	"fmt"
	"net"
)

func main() {
	// 1. ç›´æ¥listen
	listen, err := net.Listen("tcp", ":8080")
	if err != nil {
		fmt.Println("listen error: ", err)
		return
	}

	defer listen.Close()
	// æ‰“å°å‡ºç›‘å¬çš„ç«¯å£ä¿¡æ¯

	fmt.Println("listening on ", listen.Addr().String())

	for {
		// 2. Acceptæ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚
		conn, err := listen.Accept()
		if err != nil {
			fmt.Println("accept error: ", err)
			continue // è·³è¿‡æœ¬æ¬¡ ç»§ç»­ä¸‹ä¸€æ¬¡
		}

		// 3. å¼€ä¸€ä¸ªåç¨‹ å•ç‹¬å¤„ç†è¿æ¥
		go handelConn(conn)
	}
}

// å¤„ç†æ¥æ”¶åˆ°çš„è¿æ¥
// net.Connæ˜¯ä¸€ä¸ªæ¥å£,æ‹¥æœ‰Readå’ŒWriteæ–¹æ³•
func handelConn(conn net.Conn) {
	// å‡†å¤‡ä»connä¸­è¯»å–æ•°æ® å­˜å‚¨çš„åˆ‡ç‰‡

	data := make([]byte, 512)
	for {
		// è¿”å›è¯»å–çš„å­—èŠ‚æ•°ï¼Œé”™è¯¯
		n, err := conn.Read(data)
		if err != nil {
			fmt.Println("Read error: ", err)
			return
		}
		fmt.Printf("è¯»å–åˆ°å®¢æˆ·ç«¯ip: %s, é•¿åº¦ä¸ºï¼š%vçš„ä¿¡æ¯: %s\n", conn.RemoteAddr(), n, string(data))
	}
}
```
è¿è¡Œåä¼šè¾“å‡ºå¦‚ä¸‹ï¼š
```shell
 âœ˜ dongmingyan@sc â®€ ~/go_playground/play â®€ go run main.go
listening on  [::]:8080
è¯»å–åˆ°å®¢æˆ·ç«¯ip: [::1]:52266, é•¿åº¦ä¸ºï¼š512çš„ä¿¡æ¯: hello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello 
è¯»å–åˆ°å®¢æˆ·ç«¯ip: [::1]:52266, é•¿åº¦ä¸ºï¼š148çš„ä¿¡æ¯: worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello world worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello worldhello 
Read error:  EOF
```

ä»è¾“å‡ºç»“æœä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡º,å®¢æˆ·ç«¯ä¸€æ¬¡å†™å…¥çš„å†…å®¹ï¼Œåœ¨æœåŠ¡ç«¯åˆ†æˆäº†ä¸¤æ¬¡è¯»å–,ä¸”æ–­å¥åˆ†å‰²å¼‚å¸¸æ¯”å¦‚è¿™é‡Œ`148çš„ä¿¡æ¯: worldhello`,è¿™å°±æ˜¯æˆ‘ä»¬è¦è¯´çš„ç²˜åŒ…é—®é¢˜ã€‚

ä¹‹æ‰€ä»¥åˆ†æˆäº†ä¸¤æ¬¡æ˜¯å› ä¸ºï¼Œæˆ‘ä»¬æœåŠ¡ç«¯æŒ‡å®šäº†ä¸€æ¬¡æœ€å¤§è¯»å–çš„é•¿åº¦ä¸º512ä¸ªå­—èŠ‚,çº å…¶åŸå› æ˜¯å› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“ä¸€æ¬¡è¯»å¤šå°‘é•¿åº¦çš„å†…å®¹ï¼Œå¦‚æœçŸ¥é“é•¿åº¦é‚£ä¹ˆå°±ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ã€‚

ç²˜åŒ…é—®é¢˜çš„æœ¬è´¨æ˜¯ï¼š**æœåŠ¡ç«¯è¯»å–æ•°æ®æ—¶ï¼Œä¸çŸ¥é“è¦å¦‚ä½•åˆ†å‰²æ•°æ®å†…å®¹**


#### 1.3 è§£å†³ç²˜åŒ…é—®é¢˜
è§£å†³ç²˜åŒ…é—®é¢˜æœ‰å¾ˆå¤šç§æ–¹å¼ï¼Œæ¯”å¦‚ï¼š
1. çº¦å®šä¸€ä¸ªå›ºå®šé•¿åº¦ï¼Œå‘é€å’Œæ¥æ”¶éƒ½æŒ‰ç…§è¿™ä¸ªé•¿åº¦
2. ä½¿ç”¨åˆ†å‰²ç¬¦å·,æ¯æ¬¡æ¶ˆæ¯æœ«å°¾åŠ åˆ†å‰²ç¬¦ï¼Œæ¯”å¦‚æ¢è¡Œç¬¦å·
3. åœ¨æ•°æ®åŒ…ä¸­ä¸€ä¸ªå›ºå®šé•¿åº¦ç”¨äºå­˜å‚¨æœ¬æ¬¡æ¶ˆæ¯çš„é•¿åº¦ï¼Œæ¥æ”¶æ–¹æ³•è§£æå‡ºæ¥åæ ¹æ®å®ƒå»è¯»å–æ¶ˆæ¯

è¿™é‡Œé‡‡ç”¨ç¬¬ä¸‰ç§æ–¹å¼æ¼”ç¤ºï¼š
- æˆ‘ä»¬çº¦å®šæ•°æ®çš„å‰4ä¸ªå­—èŠ‚ï¼ˆ32ä½ï¼‰å­˜å‚¨æœ¬æ¬¡æ¶ˆæ¯é•¿åº¦
- æ¥æ”¶æ–¹è¯»å–æ•°æ®æ—¶ï¼Œå…ˆè¯»å–å‰4ä¸ªå­—èŠ‚è·å–åˆ°æ¶ˆæ¯é•¿åº¦ï¼Œç„¶åè¯»å–å…·ä½“å†…å®¹


è§£å†³ç²˜åŒ…ä¸»è¦æ˜¯å‡ºæ¥æ•°æ®çš„å‘é€å’Œæ¥æ”¶ï¼Œä¸»è¦ä»£ç å¦‚ä¸‹
```go
// å‘é€æ•°æ®
func send(conn net.Conn, msg string) error {
	// å‡ºäºæ€§èƒ½è€ƒè™‘ æ·»åŠ buffer
	buffer := bufio.NewWriter(conn)
	// è®¡ç®—ä¿¡æ¯é•¿åº¦ ç”¨4ä¸ªå­—èŠ‚ 32ä½è¡¨ç¤º
	length := uint32(len(msg))
	// å†™å…¥æ¶ˆæ¯é•¿åº¦  é‡‡ç”¨å¤§ç«¯åº
	err := binary.Write(buffer, binary.BigEndian, length)
	if err != nil {
		return err
	}
	// å†™å…¥æ¶ˆæ¯å†…å®¹
	err = binary.Write(buffer, binary.BigEndian, []byte(msg))
	if err != nil {
		return err
	}

	err = buffer.Flush() // å†™å…¥conn
	return err
}


// æ¥æ”¶æ¶ˆæ¯
func receive(conn net.Conn) (string, uint32, error) {
	// å‡ºäºæ€§èƒ½è€ƒè™‘ ç”¨buffer
	buffer := bufio.NewReader(conn)

	// å‡†å¤‡æ¥æ”¶æ¶ˆæ¯é•¿åº¦æ•°æ®
	var length uint32
	// ä»ä¸­è¯»å–é•¿åº¦
	err := binary.Read(buffer, binary.BigEndian, &length)
	if err != nil {
		return "", length, err
	}

	// å‡†å¤‡è¯»å–ä¿¡æ¯
	data := make([]byte, length)
	// ä»ä¸­è¯»å–å…·ä½“ä¿¡æ¯
	err = binary.Read(buffer, binary.BigEndian, data)
	if err != nil {
		return "", length, err
	}

	return string(data), length, nil
}
```

å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š
- å®¢æˆ·ç«¯ï¼š
```go
package main

import (
	"bufio"
	"encoding/binary"
	"fmt"
	"net"
	"strings"
)

func main() {
	// 1. å®¢æˆ·ç«¯æ‹¨å· tcp ip:port
	conn, err := net.Dial("tcp", "localhost:8080")
	if err != nil {
		fmt.Println("Dial error: ", err)
		return
	}

	defer conn.Close()

	// æ„å»ºä¸€ä¸ªå¾ˆé•¿çš„å­—ç¬¦ä¸² ç”±60ä¸ª hellow worldç»„æˆ
	str := strings.Repeat("hello world", 60)

	// 2. å‘é€æ•°æ®
	err = send(conn, str)
	if err != nil {
		fmt.Println("Write error: ", err)
		return
	}
}

// å‘é€æ•°æ®
func send(conn net.Conn, msg string) error {
	// å‡ºäºæ€§èƒ½è€ƒè™‘ æ·»åŠ buffer
	buffer := bufio.NewWriter(conn)
	// è®¡ç®—ä¿¡æ¯é•¿åº¦ ç”¨4ä¸ªå­—èŠ‚ 32ä½è¡¨ç¤º
	length := uint32(len(msg))
	// å†™å…¥æ¶ˆæ¯é•¿åº¦  é‡‡ç”¨å¤§ç«¯åº
	err := binary.Write(buffer, binary.BigEndian, length)
	if err != nil {
		return err
	}
	// å†™å…¥æ¶ˆæ¯å†…å®¹
	err = binary.Write(buffer, binary.BigEndian, []byte(msg))
	if err != nil {
		return err
	}

	err = buffer.Flush() // å†™å…¥conn
	return err
}
```

- æœåŠ¡ç«¯
```go
package main

import (
	"bufio"
	"encoding/binary"
	"fmt"
	"net"
)

func main() {
	// 1. ç›´æ¥listen
	listen, err := net.Listen("tcp", ":8080")
	if err != nil {
		fmt.Println("listen error: ", err)
		return
	}

	defer listen.Close()
	// æ‰“å°å‡ºç›‘å¬çš„ç«¯å£ä¿¡æ¯

	fmt.Println("listening on ", listen.Addr().String())

	for {
		// 2. Acceptæ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚
		conn, err := listen.Accept()
		if err != nil {
			fmt.Println("accept error: ", err)
			continue // è·³è¿‡æœ¬æ¬¡ ç»§ç»­ä¸‹ä¸€æ¬¡
		}

		// 3. å¼€ä¸€ä¸ªåç¨‹ å•ç‹¬å¤„ç†è¿æ¥
		go handelConn(conn)
	}
}

// å¤„ç†æ¥æ”¶åˆ°çš„è¿æ¥
// net.Connæ˜¯ä¸€ä¸ªæ¥å£,æ‹¥æœ‰Readå’ŒWriteæ–¹æ³•
func handelConn(conn net.Conn) {
	for {
		// è¿”å›æ¶ˆæ¯å†…å®¹ é”™è¯¯
		msg, n, err := receive(conn)
		if err != nil {
			fmt.Println("Read error: ", err)
			return
		}
		fmt.Printf("è¯»å–åˆ°å®¢æˆ·ç«¯ip: %s, é•¿åº¦ä¸ºï¼š%vçš„ä¿¡æ¯: %s\n", conn.RemoteAddr(), n, msg)
	}
}

// æ¥æ”¶æ¶ˆæ¯
func receive(conn net.Conn) (string, uint32, error) {
	// å‡ºäºæ€§èƒ½è€ƒè™‘ ç”¨buffer
	buffer := bufio.NewReader(conn)

	// å‡†å¤‡æ¥æ”¶æ¶ˆæ¯é•¿åº¦æ•°æ®
	var length uint32
	// ä»ä¸­è¯»å–é•¿åº¦
	err := binary.Read(buffer, binary.BigEndian, &length)
	if err != nil {
		return "", length, err
	}

	// å‡†å¤‡è¯»å–ä¿¡æ¯
	data := make([]byte, length)
	// ä»ä¸­è¯»å–å…·ä½“ä¿¡æ¯
	err = binary.Read(buffer, binary.BigEndian, data)
	if err != nil {
		return "", length, err
	}

	return string(data), length, nil
}
```
å…·ä½“æ‰§è¡Œç»“æœå¯ä»¥è‡ªè¡Œå°è¯•ã€‚

### 2. UDPå®ç°
udpç›¸å¯¹äºtcpæ›´ç®€å•ç‚¹,åœ¨æœåŠ¡ç«¯ç›´æ¥listenåå°±å¯ä»¥è¯»å†™
listenä½¿ç”¨ `listenUDP`
1. è¯»å–æ¶ˆæ¯ä½¿ç”¨`ReadFromUDP`
2. å‘é€æ¶ˆæ¯ä½¿ç”¨`WriteToUDP`

- æœåŠ¡ç«¯
```go
package main

import (
	"fmt"
	"net"
)

func main() {
	// 1. listenUDP è¿™é‡Œç¬¬äºŒä¸ªå‚æ•°éœ€è¦UDPAddr
	conn, err := net.ListenUDP("udp", &net.UDPAddr{
		IP:   net.IPv4(0, 0, 0, 0),
		Port: 8080,
	})

	if err != nil {
		fmt.Println("listenUDP failed: ", err)
		return
	}

	defer conn.Close()

	fmt.Printf("listenUDP on: %s\n", conn.LocalAddr())

	data := make([]byte, 512)
	for {
		// 2. ä½¿ç”¨ReadFromUDP è¯»å–ï¼Œç¬¬äºŒä¸ªå‚æ•°è¿”å›çš„è¿œç«¯çš„udpåœ°å€
		n, addr, err := conn.ReadFromUDP(data)
		if err != nil {
			fmt.Println("read failed: ", err)
			continue
		}

		fmt.Printf("read addr: %s length: %d, content: %s\n", addr, n, data)

		// 3. ä½¿ç”¨WriteToUDPå†™ ç¬¬äºŒä¸ªå‚æ•°éœ€è¦æ˜¯ä¼šå†™çš„åœ°å€
		_, err = conn.WriteToUDP([]byte("æ”¶åˆ°æ¶ˆæ¯"), addr)
		if err != nil {
			fmt.Println("write failed: ", err)
			continue
		}
	}
}
```

- å®¢æˆ·ç«¯
```go
package main

import (
	"fmt"
	"net"
)

func main() {
	// 1. Dial ç›¸æ¯”äºtcp è¿™é‡Œæ”¹æˆudp
	conn, err := net.Dial("udp", "localhost:8080")

	if err != nil {
		fmt.Println("udp Dial failed: ", err)
		return
	}

	defer conn.Close()

	// 2. è¯»å†™éƒ½å’Œtcpä¸€æ ·
	_, err = conn.Write([]byte("hello server!"))
	if err != nil {
		fmt.Println("udp Write failed: ", err)
		return
	}

	// 3. è¯»å’Œtcpä¸€æ ·
	data := make([]byte, 512)
	_, err = conn.Read(data)
	if err != nil {
		fmt.Println("udp Read failed: ", err)
		return
	}

	fmt.Printf("udp read from server,content: %s\n", data)
}
```

### 3. æ€»ç»“
1. ä»å®¢æˆ·ç«¯çœ‹,æ— è®ºæ˜¯`tcp`å’Œ`udp`ä½¿ç”¨ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯é€šè¿‡`net.Dial`ã€`Write`ã€`Read`å®Œæˆï¼ŒåŒºåˆ«åœ¨äºdialçš„æ—¶å€™ç±»å‹æ˜¯`tcp`è¿˜æ˜¯`dup`
2. ä»æœåŠ¡ç«¯çœ‹,åŒºåˆ«ç¨å¤§
   - å¯¹äºtcpéœ€è¦æœ‰ä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥`listen`,ç¬¬äºŒéƒ¨`Accept`ï¼Œä½†æ˜¯udpåªæœ‰listen
   - åœ¨è¯»å†™ä¸Šï¼Œ`tcp`ç”¨`Write`å’Œ`Read`,è€Œ`udp`ç”¨`WriteToUDP`ã€`ReadFromUDP`ç¨å¾®ç¹çäº†ç‚¹ã€‚


### 4. èŠå¤©å®¤åŠŸèƒ½å®æˆ˜
ä¸Šé¢æˆ‘ä»¬è™½ç„¶è¿›è¡Œäº†äº›ç»ƒä¹ ,ä½†æ˜¯å®æˆ˜æ„ä¹‰ä¸å¤§ï¼Œè¿™é‡Œæˆ‘ä»¬å†™ä¸€ä¸ªç¨å¾®è´´è¿‘ç‚¹çš„å®æˆ˜ã€‚

é€šè¿‡tcpå®ç°ï¼ŒåŠŸèƒ½å¦‚ä¸‹ï¼š
1. å½“æœ‰å®¢æˆ·ç«¯åŠ å…¥,é€šçŸ¥æ‰€æœ‰å®¢æˆ·ç«¯
2. å½“æœ‰å®¢æˆ·ç«¯é€€å‡º,é€šçŸ¥æ‰€æœ‰å®¢æˆ·ç«¯

è¿™æ®µä»£ç æ¯”è¾ƒå¤šï¼Œå½“ç„¶ä¹Ÿä¸å¤Ÿå®Œå–„ï¼Œçº¯å±ç»ƒæ‰‹ï¼Œçœ‹çœ‹å°±å¥½ï¼

- æœåŠ¡ç«¯
```go
package main

import (
	"bufio"
	"encoding/binary"
	"fmt"
	"log"
	"net"
)

// å®šä¹‰å®¢æˆ·ç«¯ç»“æ„ä½“
type client struct {
	name string   // å®¢æˆ·ç«¯åç§°
	conn net.Conn // è¿™é‡Œå­˜å®¢æˆ·ç«¯çš„è¿æ¥
}

// å­˜å‚¨å®¢æˆ·ç«¯é›†åˆ
var clients = make(map[string]*client)

// å‘å®¢æˆ·ç«¯å‘ä¿¡æ¯
func (c *client) sendMsg(msg string) error {
	err := send(c.conn, msg)
	return err
}

// å‘å®¢æˆ·ç«¯å¹¿æ’­
func broadcast(msg string) {
	for _, client := range clients {
		err := client.sendMsg(msg)
		if err != nil {
			fmt.Println("broadcast error: ", err)
		}
	}
}

func main() {
	listen, err := net.Listen("tcp", ":8080")
	if err != nil {
		fmt.Println("listen error: ", err)
		return
	}

	defer listen.Close()
	log.Printf("chat server started, listening on: %s", listen.Addr().String())

	for {
		conn, err := listen.Accept()
		if err != nil {
			fmt.Println("accept err: ", err)
			continue
		}

		go handleConn(conn)
	}
}

func handleConn(conn net.Conn) {
	// å…ˆè·å–å®¢æˆ·ç«¯å,çº¦å®šç¬¬ä¸€å…ˆå¡«å†™å®¢æˆ·ç«¯åç§°
	name, _, err := receive(conn)
	if err != nil {
		fmt.Println("receive error: ", err)
		return
	}

	defer conn.Close()
	defer userLeave(name) // ç”¨æˆ·ç¦»å¼€

	// å°†è¿æ¥å­˜å…¥clientsä¸­
	clients[name] = &client{name: name, conn: conn}
	// å¹¿æ’­åŠ å…¥æ¶ˆæ¯
	broadcast(fmt.Sprintf("æ¬¢è¿ ã€%sã€‘åŠ å…¥èŠå¤©", name))

	for {
		msg, _, err := receive(conn)
		if err != nil {
			fmt.Println("receive error: ", err)
			return
		}

		broadcast(fmt.Sprintf("ã€%sã€‘å‘è¨€: %s", name, msg))
	}
}

// ç”¨æˆ·é€€å‡º
func userLeave(name string) {
	// ä»clientsä¸­åˆ é™¤ç”¨æˆ·
	delete(clients, name)
	broadcast(fmt.Sprintf("ã€%sã€‘é€€å‡ºèŠå¤©", name))
}

// å‘é€æ•°æ®
func send(conn net.Conn, msg string) error {
	// å‡ºäºæ€§èƒ½è€ƒè™‘ æ·»åŠ buffer
	buffer := bufio.NewWriter(conn)
	// è®¡ç®—ä¿¡æ¯é•¿åº¦ ç”¨4ä¸ªå­—èŠ‚ 32ä½è¡¨ç¤º
	length := uint32(len(msg))
	// å†™å…¥æ¶ˆæ¯é•¿åº¦  é‡‡ç”¨å¤§ç«¯åº
	err := binary.Write(buffer, binary.BigEndian, length)
	if err != nil {
		return err
	}
	// å†™å…¥æ¶ˆæ¯å†…å®¹
	err = binary.Write(buffer, binary.BigEndian, []byte(msg))
	if err != nil {
		return err
	}

	err = buffer.Flush() // å†™å…¥conn
	return err
}

// æ¥æ”¶æ¶ˆæ¯
func receive(conn net.Conn) (string, uint32, error) {
	// å‡ºäºæ€§èƒ½è€ƒè™‘ ç”¨buffer
	buffer := bufio.NewReader(conn)

	// å‡†å¤‡æ¥æ”¶æ¶ˆæ¯é•¿åº¦æ•°æ®
	var length uint32
	// ä»ä¸­è¯»å–é•¿åº¦
	err := binary.Read(buffer, binary.BigEndian, &length)
	if err != nil {
		return "", length, err
	}

	// å‡†å¤‡è¯»å–ä¿¡æ¯
	data := make([]byte, length)
	// ä»ä¸­è¯»å–å…·ä½“ä¿¡æ¯
	err = binary.Read(buffer, binary.BigEndian, data)
	if err != nil {
		return "", length, err
	}

	return string(data), length, nil
}
```

- å®¢æˆ·ç«¯
```go
package main

import (
	"bufio"
	"encoding/binary"
	"fmt"
	"log"
	"net"
)

// å®šä¹‰å®¢æˆ·ç«¯ç»“æ„ä½“
type client struct {
	name string   // å®¢æˆ·ç«¯åç§°
	conn net.Conn // è¿™é‡Œå­˜å®¢æˆ·ç«¯çš„è¿æ¥
}

// å­˜å‚¨å®¢æˆ·ç«¯é›†åˆ
var clients = make(map[string]*client)

// å‘å®¢æˆ·ç«¯å‘ä¿¡æ¯
func (c *client) sendMsg(msg string) error {
	err := send(c.conn, msg)
	return err
}

// å‘å®¢æˆ·ç«¯å¹¿æ’­
func broadcast(msg string) {
	for _, client := range clients {
		err := client.sendMsg(msg)
		if err != nil {
			fmt.Println("broadcast error: ", err)
		}
	}
}

func main() {
	listen, err := net.Listen("tcp", ":8080")
	if err != nil {
		fmt.Println("listen error: ", err)
		return
	}

	defer listen.Close()
	log.Printf("chat server started, listening on: %s", listen.Addr().String())

	for {
		conn, err := listen.Accept()
		if err != nil {
			fmt.Println("accept err: ", err)
			continue
		}

		go handleConn(conn)
	}
}

func handleConn(conn net.Conn) {
	// å…ˆè·å–å®¢æˆ·ç«¯å,çº¦å®šç¬¬ä¸€å…ˆå¡«å†™å®¢æˆ·ç«¯åç§°
	name, _, err := receive(conn)
	if err != nil {
		fmt.Println("receive error: ", err)
		return
	}

	defer conn.Close()
	defer userLeave(name) // ç”¨æˆ·ç¦»å¼€

	// å°†è¿æ¥å­˜å…¥clientsä¸­
	clients[name] = &client{name: name, conn: conn}
	// å¹¿æ’­åŠ å…¥æ¶ˆæ¯
	broadcast(fmt.Sprintf("æ¬¢è¿ ã€%sã€‘åŠ å…¥èŠå¤©", name))

	for {
		msg, _, err := receive(conn)
		if err != nil {
			fmt.Println("receive error: ", err)
			return
		}

		broadcast(fmt.Sprintf("ã€%sã€‘å‘è¨€: %s", name, msg))
	}
}

// ç”¨æˆ·é€€å‡º
func userLeave(name string) {
	// ä»clientsä¸­åˆ é™¤ç”¨æˆ·
	delete(clients, name)
	broadcast(fmt.Sprintf("ã€%sã€‘é€€å‡ºèŠå¤©", name))
}

// å‘é€æ•°æ®
func send(conn net.Conn, msg string) error {
	// å‡ºäºæ€§èƒ½è€ƒè™‘ æ·»åŠ buffer
	buffer := bufio.NewWriter(conn)
	// è®¡ç®—ä¿¡æ¯é•¿åº¦ ç”¨4ä¸ªå­—èŠ‚ 32ä½è¡¨ç¤º
	length := uint32(len(msg))
	// å†™å…¥æ¶ˆæ¯é•¿åº¦  é‡‡ç”¨å¤§ç«¯åº
	err := binary.Write(buffer, binary.BigEndian, length)
	if err != nil {
		return err
	}
	// å†™å…¥æ¶ˆæ¯å†…å®¹
	err = binary.Write(buffer, binary.BigEndian, []byte(msg))
	if err != nil {
		return err
	}

	err = buffer.Flush() // å†™å…¥conn
	return err
}

// æ¥æ”¶æ¶ˆæ¯
func receive(conn net.Conn) (string, uint32, error) {
	// å‡ºäºæ€§èƒ½è€ƒè™‘ ç”¨buffer
	buffer := bufio.NewReader(conn)

	// å‡†å¤‡æ¥æ”¶æ¶ˆæ¯é•¿åº¦æ•°æ®
	var length uint32
	// ä»ä¸­è¯»å–é•¿åº¦
	err := binary.Read(buffer, binary.BigEndian, &length)
	if err != nil {
		return "", length, err
	}

	// å‡†å¤‡è¯»å–ä¿¡æ¯
	data := make([]byte, length)
	// ä»ä¸­è¯»å–å…·ä½“ä¿¡æ¯
	err = binary.Read(buffer, binary.BigEndian, data)
	if err != nil {
		return "", length, err
	}

	return string(data), length, nil
}
```

